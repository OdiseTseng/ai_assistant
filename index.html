<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Odise's Personal Gemini Assistant">
    <title>Odise Gemini Assistant</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --text-color: #e2e8f0;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --accent-color: #38bdf8;
            --accent-hover: #0ea5e9;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --input-bg: rgba(15, 23, 42, 0.8);
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --sidebar-width: 250px;
            --header-height: 60px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 70%);
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* --- LAYOUT STRUCTURE --- */

        /* Sidebar (Desktop) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent-color);
            border-bottom: 1px solid var(--card-border);
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            transition: background 0.2s;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-color);
            border-left: 3px solid var(--accent-color);
        }

        .nav-footer {
            padding: 20px;
            font-size: 0.8rem;
            color: #64748b;
            border-top: 1px solid var(--card-border);
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            /* Default Desktop */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: calc(100% - var(--sidebar-width));
        }

        /* Top Bar (Mobile / Global Actions) */
        .top-bar {
            height: var(--header-height);
            display: none;
            /* Hidden on desktop by default unless needed */
            align-items: center;
            padding: 0 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--card-border);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 15px;
            padding: 0;
        }

        /* Dashboard Grid */
        .dashboard-container {
            padding: 20px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Station Tags & Lists */
        .station-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .station-tag {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: default;
            position: relative;
        }

        .station-tag .remove-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
        }

        .result-box {
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
            min-height: 20px;
        }

        /* Inputs & Buttons */
        button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .btn-add {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
            border: 1px dashed var(--accent-color);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            margin-top: 10px;
        }

        .btn-primary:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
            opacity: 0.7;
        }

        textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--card-border);
            color: var(--text-color);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        /* Smaller modal for settings */
        .modal-content.sm {
            max-width: 500px;
            height: auto;
            max-height: 90vh;
            /* Allow scroll if needed on small screens */
            display: block;
            /* Override flex */
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.95);
        }

        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Modal Sidebar Logic (Same as before) */
        .modal-sidebar {
            width: 30%;
            border-right: 1px solid var(--card-border);
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.5);
        }

        .modal-main {
            width: 70%;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }

        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
        }

        .grid-item.selected {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .category-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .category-item.active {
            background: var(--accent-color);
            color: white;
        }

        /* SETTINGS FORM */
        .settings-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .form-sub-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .sub-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        input[type="time"],
        input[type="password"],
        input[type="text"] {
            background-color: var(--input-bg);
            border: 1px solid var(--card-border);
            color: var(--text-color);
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            color-scheme: dark;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .status-msg {
            font-size: 0.85em;
            margin-top: 5px;
            color: #aaa;
            min-height: 1.2em;
        }

        /* RESPONSIVE MEDIA QUERIES */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                /* Hide sidebar */
            }

            .sidebar.active {
                transform: translateX(0);
                /* Show sidebar */
                box-shadow: 10px 0 50px rgba(0, 0, 0, 0.5);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .top-bar {
                display: flex;
                /* Show hamburger */
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            /* Modal stack */
            .modal-body {
                flex-direction: column;
            }

            .modal-sidebar {
                width: 100%;
                height: 30%;
                border-right: none;
                border-bottom: 1px solid var(--card-border);
            }

            .modal-main {
                width: 100%;
                height: 70%;
            }

            .modal-main {
                width: 100%;
                height: 70%;
            }
        }

        /* Help Modal Specifics */
        .help-content {
            padding: 10px 20px;
            line-height: 1.6;
            color: var(--text-color);
        }

        .help-content h2,
        .help-content h3 {
            color: var(--accent-color);
            margin-top: 1.5em;
        }

        .help-content h2:first-child {
            margin-top: 0;
        }

        .help-content ul,
        .help-content ol {
            padding-left: 25px;
        }

        .help-content li {
            margin-bottom: 8px;
        }

        .help-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Floating Action Button (FAB) */
        .fab-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            font-size: 24px;
            cursor: pointer;
            z-index: 900;
            /* Above cards, below modal */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }

        .fab-btn:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }
    </style>
</head>

<body>

    <!-- Sidebar Menu -->
    <nav class="sidebar" id="sidebar">
        <div class="logo-area">
            Odise Assistant
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="navigate('dashboard')">
                ğŸ  å„€è¡¨æ¿
            </div>
            <div class="nav-item" onclick="openSettings()">
                âš™ï¸ å€‹äººåŒ–è¨­å®š
            </div>
            <div class="nav-item" onclick="openHelpModal()">
                â“ èªªæ˜æ–‡ä»¶
            </div>
        </div>
        <div class="nav-footer" id="versionInfo">
            Version Info
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Mobile Top Bar -->
        <div class="top-bar">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <span>Odise Assistant</span>
        </div>

        <div class="dashboard-container">
            <!-- Global Info / Debug -->
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <div id="statusText" style="margin-right:15px; align-self:center; font-size:0.9em; color:#94a3b8;">
                    ç‹€æ…‹ï¼šç­‰å¾…æ“ä½œ...</div>
                <button onclick="toggleDebug()" style="padding:4px 10px; font-size:12px;">Debug Info</button>
            </div>

            <div id="debugArea" class="card full-width" style="display: none; margin-bottom:20px;">
                <h2>ğŸ¤– åŸå§‹å›æ‡‰ (Debug)</h2>
                <div id="responseArea" style="white-space: pre-wrap; line-height: 1.6;"></div>
            </div>

            <div class="dashboard-grid">
                <!-- Section 1: Custom Prompt + Action -->
                <div class="card full-width">
                    <h2>ğŸ“ ä»Šæ—¥äº¤é€šæŸ¥è©¢</h2>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <textarea id="promptPreview" placeholder="å°‡æ ¹æ“šæ‚¨çš„è¨­å®šè‡ªå‹•ç”Ÿæˆæç¤ºè©..." readonly
                            style="opacity: 0.7; height:80px;"></textarea>
                        <button id="sendBtn" onclick="askGemini()" class="btn-primary" disabled>
                            ğŸ“ æ ¹æ“šè¨­å®šå–å¾— GPS ä¸¦æŸ¥è©¢
                        </button>
                    </div>
                </div>

                <!-- Section 2: Train -->
                <div class="card">
                    <h2>ğŸš„ ç«è»Š <button class="btn-add" onclick="openStationModal('train')">+</button></h2>
                    <div id="train-list" class="station-list"></div>
                    <div id="train-result" class="result-box"></div>
                </div>

                <!-- Section 3: MRT (New) -->
                <div class="card">
                    <h2>æ·é‹ <button class="btn-add" onclick="openStationModal('mrt')">+</button></h2>
                    <div id="mrt-list" class="station-list"></div>
                    <div id="mrt-result" class="result-box"></div>
                </div>

                <!-- Section 3: Bus -->
                <div class="card">
                    <h2>ğŸšŒ å…¬è»Š <button class="btn-add" onclick="openStationModal('bus')">+</button></h2>
                    <div id="bus-list" class="station-list"></div>
                    <div id="bus-result" class="result-box"></div>
                </div>

                <!-- Section 4: Bike -->
                <div class="card">
                    <h2>ğŸš² YouBike <button class="btn-add" onclick="openStationModal('bike')">+</button></h2>
                    <div id="bike-list" class="station-list"></div>
                    <div id="bike-result" class="result-box"></div>
                </div>

                <!-- Section 5: Integrated Itinerary (New) -->
                <div class="card full-width" style="margin-top:20px; border-color: var(--accent-color);">
                    <h2>ğŸš© æœ€ä½³è½‰ä¹˜æ–¹æ¡ˆ (æœªä¾†2å°æ™‚)</h2>
                    <div id="itinerary-result" class="result-box" style="padding:15px; min-height:100px;">
                        <span style="color:#666">ç­‰å¾…æŸ¥è©¢...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Floating Action Button for Help -->
    <button class="fab-btn" onclick="openHelpModal()" title="é–‹å•Ÿèªªæ˜">?</button>

    <!-- STATION MODAL (Add Stations) -->
    <div id="stationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0;">æ–°å¢ç«™é»</h3>
                <div style="flex-grow: 1; display: flex; gap: 5px; position: relative; margin: 0 15px;">
                    <input type="text" id="modalSearch" style="margin: 0; padding:6px;" placeholder="æœå°‹ç«™é»...">
                    <button id="clearSearchBtn" onclick="clearSearch()"
                        style="display:none; position:absolute; right:5px; top:5px; padding:2px 5px;">X</button>
                </div>
                <button onclick="closeModal('stationModal')"
                    style="border:none; font-size:1.5rem; background:transparent;">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="modal-sidebar" id="modalSidebar"></div>
                <div class="modal-main">
                    <div id="loadingIndicator" style="display:none; text-align:center;">AI æœå°‹ä¸­...</div>
                    <div id="modalGrid" class="station-grid"></div>
                    <div id="modalHelpText" style="margin-top:auto; color:#64748b; font-size:0.8em;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content sm">
            <div class="modal-header">
                <h3>âš™ï¸ å€‹äººåŒ–è¨­å®š</h3>
                <div style="display:flex; gap:10px;">
                    <button onclick="openHelpModal()" style="padding:4px 10px; font-size:0.9em;">â“ èªªæ˜</button>
                    <button onclick="closeModal('settingsModal')">Ã—</button>
                </div>
            </div>
            <div class="settings-form">
                <!-- API Key -->
                <div class="form-group">
                    <label class="form-label">Google Gemini API Key</label>
                    <input type="password" id="settingApiKey" placeholder="è²¼ä¸Š API Key">
                </div>

                <hr style="border:0; border-top:1px solid var(--card-border); margin:20px 0;">

                <!-- Work Settings -->
                <div class="form-group">
                    <label class="form-label">ğŸ¢ ä¸Šç­è¨­å®š</label>
                    <span class="form-sub-label">ä¸Šç­æ™‚é–“</span>
                    <input type="time" id="settingWorkTime">

                    <span class="form-sub-label" style="margin-top:10px;">äº¤é€šå·¥å…·çµ„åˆ (é€”ä¸­)</span>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" name="workTrans" value="train"> ç«è»Š</label>
                        <label class="checkbox-label"><input type="checkbox" name="workTrans" value="mrt"> æ·é‹</label>
                        <label class="checkbox-label"><input type="checkbox" name="workTrans" value="bus"> å…¬è»Š</label>
                        <label class="checkbox-label"><input type="checkbox" name="workTrans" value="bike">
                            YouBike</label>
                    </div>

                    <!-- Work Last Mile -->
                    <div class="sub-box">
                        <label class="form-label" style="font-size:0.95em;">ğŸ æœ€å¾Œä¸€å“©è·¯ (æŠµé”å…¬å¸)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="settingWorkStation" placeholder="é»æ“Šé¸æ“‡ç«™é»..." readonly
                                onclick="openSourceSelectModal('work')" style="cursor:pointer; background:#2a2a2a;">
                            <button onclick="validateLastMile('work')" id="checkWorkBtn"
                                style="white-space:nowrap; width:auto; padding:0 12px;">æª¢æŸ¥</button>
                        </div>
                        <div id="workStatus" class="status-msg"></div>

                        <span class="form-sub-label" style="margin-top:5px;">äº¤é€šå·¥å…·</span>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" name="workLmTrans" value="train">
                                ç«è»Š</label>
                            <label class="checkbox-label"><input type="checkbox" name="workLmTrans" value="mrt">
                                æ·é‹</label>
                            <label class="checkbox-label"><input type="checkbox" name="workLmTrans" value="bus">
                                å…¬è»Š</label>
                            <label class="checkbox-label"><input type="checkbox" name="workLmTrans" value="bike">
                                YouBike</label>
                        </div>
                    </div>
                </div>

                <!-- Home Settings -->
                <div class="form-group">
                    <label class="form-label">ğŸ  ä¸‹ç­è¨­å®š</label>
                    <span class="form-sub-label">ä¸‹ç­æ™‚é–“</span>
                    <input type="time" id="settingHomeTime">

                    <span class="form-sub-label" style="margin-top:10px;">äº¤é€šå·¥å…·çµ„åˆ (é€”ä¸­)</span>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" name="homeTrans" value="train"> ç«è»Š</label>
                        <label class="checkbox-label"><input type="checkbox" name="homeTrans" value="mrt"> æ·é‹</label>
                        <label class="checkbox-label"><input type="checkbox" name="homeTrans" value="bus"> å…¬è»Š</label>
                        <label class="checkbox-label"><input type="checkbox" name="homeTrans" value="bike">
                            YouBike</label>
                    </div>

                    <!-- Home Last Mile -->
                    <div class="sub-box">
                        <label class="form-label" style="font-size:0.95em;">ğŸ æœ€å¾Œä¸€å“©è·¯ (æŠµé”ä½å®¶)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="settingHomeStation" placeholder="é»æ“Šé¸æ“‡ç«™é»..." readonly
                                onclick="openSourceSelectModal('home')" style="cursor:pointer; background:#2a2a2a;">
                            <button onclick="validateLastMile('home')" id="checkHomeBtn"
                                style="white-space:nowrap; width:auto; padding:0 12px;">æª¢æŸ¥</button>
                        </div>
                        <div id="homeStatus" class="status-msg"></div>

                        <span class="form-sub-label" style="margin-top:5px;">äº¤é€šå·¥å…·</span>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" name="homeLmTrans" value="train">
                                ç«è»Š</label>
                            <label class="checkbox-label"><input type="checkbox" name="homeLmTrans" value="mrt">
                                æ·é‹</label>
                            <label class="checkbox-label"><input type="checkbox" name="homeLmTrans" value="bus">
                                å…¬è»Š</label>
                            <label class="checkbox-label"><input type="checkbox" name="homeLmTrans" value="bike">
                                YouBike</label>
                        </div>
                    </div>
                </div>

                <button class="btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
            </div>

            <!-- Source Selection Modal (New) -->
            <div id="sourceSelectModal" class="modal-overlay" style="z-index: 2000;">
                <div class="modal-content sm" style="max-width: 400px; text-align: center;">
                    <div class="modal-header">
                        <h3>é¸æ“‡ç«™é»</h3>
                        <button onclick="closeModal('sourceSelectModal')">Ã—</button>
                    </div>
                    <div class="modal-body" style="padding: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button class="btn-menu" onclick="openStationModal('train', 'select')">ğŸš† ç«è»Š</button>
                            <button class="btn-menu" onclick="openStationModal('mrt', 'select')">ğŸš‡ æ·é‹</button>
                            <button class="btn-menu" onclick="openStationModal('bus', 'select')">ğŸšŒ å…¬è»Š</button>
                            <button class="btn-menu" onclick="openStationModal('bike', 'select')">ğŸš² YouBike</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal-content sm">
            <div class="modal-header">
                <h3>â“ ä½¿ç”¨èªªæ˜</h3>
                <button onclick="closeModal('helpModal')">Ã—</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div class="help-content">
                    <h2>Odise Gemini Assistant</h2>
                    <p>ä¸€å€‹åŸºæ–¼ Google Gemini API çš„å€‹äººåŠ©ç†ç¶²é ï¼Œæ•´åˆäº†äº¤é€šè³‡è¨ŠæŸ¥è©¢åŠŸèƒ½ã€‚</p>

                    <h3>âœ¨ åŠŸèƒ½ç‰¹è‰²</h3>
                    <ul>
                        <li><strong>äº¤é€šæ™‚åˆ»æŸ¥è©¢</strong>ï¼šç«è»Šã€å…¬è»Šã€YouBike (è‡ªå®šç¾©ç«™é»)ã€‚</li>
                        <li><strong>GPS å®šä½</strong>ï¼šè‡ªå‹•æŠ“å–ç•¶å‰ä½ç½®ä»¥æä¾›æœ€è¿‘ç«™é»è³‡è¨Šã€‚</li>
                        <li><strong>è‡ªå‹•ç‰ˆæœ¬è™Ÿ</strong>ï¼šæ¯æ¬¡ Git Commit è‡ªå‹•æ³¨å…¥æ›´æ–°æ™‚é–“ã€‚</li>
                    </ul>

                    <h3>ğŸš€ å¦‚ä½•ä½¿ç”¨</h3>
                    <ol>
                        <li><strong>è¨­å®š API Key</strong>ï¼š
                            <ul>
                                <li>å‰å¾€ <a href="https://aistudio.google.com/" target="_blank"
                                        style="color:var(--accent-color)">Google AI Studio</a> ç”³è«‹ API Keyã€‚</li>
                                <li>åœ¨å€‹äººåŒ–è¨­å®šä¸­è¼¸å…¥ Key ä¸¦å„²å­˜ã€‚</li>
                                <li><em>æ³¨æ„ï¼šKey åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ LocalStorage ä¸­ï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚</em></li>
                            </ul>
                        </li>
                        <li><strong>æ–°å¢ç«™é»</strong>ï¼š
                            <ul>
                                <li>é»æ“Šå„å€å¡Šçš„ã€Œ+ã€æŒ‰éˆ•ã€‚</li>
                                <li><strong>ç«è»Š</strong>ï¼šå¯é€éå·¦å´ç¸£å¸‚é¸å–®æˆ–ä¸Šæ–¹æœå°‹æ¡†å°‹æ‰¾ç«™é»ã€‚</li>
                                <li><strong>å…¬è»Š/YouBike</strong>ï¼šç›´æ¥åœ¨æœå°‹æ¡†è¼¸å…¥ç«™é»åç¨± (å¦‚ "307", "æ·é‹æ¿æ©‹ç«™")ï¼Œä¸¦é»æ“Šã€Œæ–°å¢ã€ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>ç™¼é€æŸ¥è©¢</strong>ï¼š
                            <ul>
                                <li>é»æ“Šã€Œæ ¹æ“šè¨­å®šå–å¾— GPS ä¸¦æŸ¥è©¢ã€ã€‚</li>
                                <li>å…è¨±ç€è¦½å™¨å®šä½æ¬Šé™ã€‚</li>
                                <li>Gemini å°‡æœƒæ ¹æ“šæ‚¨çš„ç«™é»åˆ—è¡¨èˆ‡ä½ç½®å›è¦†è³‡è¨Šã€‚</li>
                            </ul>
                        </li>
                    </ol>

                    <h3>â“ å¸¸è¦‹å•é¡Œ</h3>
                    <ul>
                        <li><strong>Q: é é¢ä¸€ç›´æç¤ºã€Œå°šæœªåµæ¸¬åˆ°é‡‘é‘°ã€ï¼Ÿ</strong>
                            <p style="margin-top:5px;">è«‹ç¢ºèªæ‚¨æœ‰é»æ“Šã€Œå„²å­˜è¨­å®šã€æŒ‰éˆ•ã€‚<br>
                                <strong>å¦‚æœæ‚¨ä½¿ç”¨ VS Code çš„ Preview åŠŸèƒ½</strong>ï¼šå»ºè­°ç›´æ¥ç”¨é›»è…¦çš„ <strong>Chrome ç€è¦½å™¨</strong> é–‹å•Ÿ
                                <code>index.html</code> æª”æ¡ˆã€‚
                            </p>
                        </li>
                        <li><strong>Q: ç‚ºä»€éº¼ GPS æ²’åæ‡‰ï¼Ÿ</strong>
                            <p style="margin-top:5px;">è«‹ç¢ºèªç€è¦½å™¨æœ‰å…è¨±ç¶²é å­˜å–ä½ç½®æ¬Šé™ã€‚<br>
                                éœ€è¦åœ¨ <code>https</code> æˆ– <code>file://</code> (æœ¬åœ°æª”æ¡ˆ) ç’°å¢ƒä¸‹åŸ·è¡Œã€‚</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="version.js"></script>
    <script src="station_data.js"></script>
    <script>
        // --- State ---
        const DEFAULT_SETTINGS = {
            apiKey: "",
            workTime: "09:00",
            homeTime: "18:00",
            workTrans: ["train", "mrt", "bus", "bike"],
            homeTrans: ["train", "mrt", "bus", "bike"],
            workLastMile: { name: "", trans: [], coords: null },
            homeLastMile: { name: "", trans: [], coords: null }
        };

        const state = {
            train: [], // Loaded in init
            mrt: [],
            bus: [],
            bike: [],
            settings: DEFAULT_SETTINGS
        };

        // --- Init ---
        window.onload = function () {
            loadState();

            // Legacy Migration (for API Key from old localStorage key)
            const oldKey = localStorage.getItem('user_gemini_key');
            if (oldKey && !state.settings.apiKey) {
                state.settings.apiKey = oldKey;
                saveState(); // Consolidate
                localStorage.removeItem('user_gemini_key'); // Clean up
            }

            // Render
            renderAllStations();
            updatePromptPreview();
            checkKeyStatus();

            // Auto-open settings if incomplete
            checkSettingsAndPrompt();

            // Version
            if (typeof BUILD_INFO !== 'undefined') {
                document.getElementById('versionInfo').innerText = `v${BUILD_INFO.time}`;
            }
        };

        function loadState() {
            // Stations
            state.train = JSON.parse(localStorage.getItem('user_stations_train')) || [];
            state.mrt = JSON.parse(localStorage.getItem('user_stations_mrt')) || [];
            state.bus = JSON.parse(localStorage.getItem('user_stations_bus')) || [];
            state.bike = JSON.parse(localStorage.getItem('user_stations_bike')) || [];

            // Legacy Data Migration (String -> Object)
            ['train', 'mrt', 'bus', 'bike'].forEach(type => {
                if (state[type] && state[type].length > 0 && typeof state[type][0] === 'string') {
                    state[type] = state[type].map(s => ({ name: s, lat: null, lng: null }));
                }
            });

            // Settings
            const savedSettings = JSON.parse(localStorage.getItem('user_settings'));
            if (savedSettings) {
                state.settings = { ...DEFAULT_SETTINGS, ...savedSettings };

                // Migrate old 'lastMile' (generic) to 'homeLastMile' if needed
                if (savedSettings.lastMile) {
                    // Only overwrite if homeLastMile is empty
                    if (!state.settings.homeLastMile.name) {
                        state.settings.homeLastMile = savedSettings.lastMile;
                    }
                    delete state.settings.lastMile; // Cleanup
                }

                // Ensure structure
                if (!state.settings.workLastMile) state.settings.workLastMile = DEFAULT_SETTINGS.workLastMile;
                if (!state.settings.homeLastMile) state.settings.homeLastMile = DEFAULT_SETTINGS.homeLastMile;
            }
        }

        function saveState() {
            localStorage.setItem('user_stations_train', JSON.stringify(state.train));
            localStorage.setItem('user_stations_mrt', JSON.stringify(state.mrt));
            localStorage.setItem('user_stations_bus', JSON.stringify(state.bus));
            localStorage.setItem('user_stations_bike', JSON.stringify(state.bike));
            localStorage.setItem('user_settings', JSON.stringify(state.settings));
            updatePromptPreview();
            checkKeyStatus();
        }

        // --- UI Navigation ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function navigate(page) {
            // Placeholder for single page nav logic if expanded
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function openSettings() {
            // Load current settings into form
            document.getElementById('settingApiKey').value = state.settings.apiKey;
            document.getElementById('settingWorkTime').value = state.settings.workTime;
            document.getElementById('settingHomeTime').value = state.settings.homeTime;
            document.getElementById('settingWorkStation').value = state.settings.workLastMile.name || "";
            document.getElementById('settingHomeStation').value = state.settings.homeLastMile.name || "";
            document.getElementById('workStatus').innerText = '';
            document.getElementById('homeStatus').innerText = '';

            // Apply Checkboxes Logic
            const setCheckboxes = (name, values) => {
                document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
                    cb.checked = (values || []).includes(cb.value);
                });
            };

            setCheckboxes('workTrans', state.settings.workTrans);
            setCheckboxes('homeTrans', state.settings.homeTrans);
            setCheckboxes('workLmTrans', state.settings.workLastMile.trans);
            setCheckboxes('homeLmTrans', state.settings.homeLastMile.trans);
            renderStatus('work', state.settings.workLastMile);
            renderStatus('home', state.settings.homeLastMile);

            document.getElementById('settingsModal').classList.add('active');
            if (window.innerWidth <= 768) toggleSidebar();
        }

        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        function renderStatus(type, obj) {
            const div = document.getElementById(`${type}Status`);
            if (obj.coords) {
                div.innerHTML = `<span style="color:var(--success-color)">âœ… å·²é©—è­‰ (åº§æ¨™: ${obj.coords})</span>`;
            } else {
                div.innerHTML = "";
            }
        }

        function saveSettings() {
            const s = state.settings;
            s.apiKey = document.getElementById('settingApiKey').value.trim();
            s.workTime = document.getElementById('settingWorkTime').value;
            s.homeTime = document.getElementById('settingHomeTime').value;

            const getCheckboxes = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

            s.workTrans = getCheckboxes('workTrans');
            s.homeTrans = getCheckboxes('homeTrans');

            // Work Last Mile
            s.workLastMile.name = document.getElementById('settingWorkStation').value.trim();
            s.workLastMile.trans = getCheckboxes('workLmTrans');

            // Home Last Mile
            s.homeLastMile.name = document.getElementById('settingHomeStation').value.trim();
            s.homeLastMile.trans = getCheckboxes('homeLmTrans');

            saveState();
            closeModal('settingsModal');
            alert("è¨­å®šå·²å„²å­˜ï¼");
        }

        async function validateLastMile(type) {
            const inputId = type === 'work' ? 'settingWorkStation' : 'settingHomeStation';
            const checkId = type === 'work' ? 'workLmTrans' : 'homeLmTrans';
            const btnId = type === 'work' ? 'checkWorkBtn' : 'checkHomeBtn';
            const statusId = type === 'work' ? 'workStatus' : 'homeStatus';

            const name = document.getElementById(inputId).value.trim();
            const types = Array.from(document.querySelectorAll(`input[name="${checkId}"]:checked`)).map(cb => cb.value);
            const key = document.getElementById('settingApiKey').value.trim();

            if (!name) return alert("è«‹è¼¸å…¥ç«™é»åç¨±");
            if (types.length === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€ç¨®äº¤é€šå·¥å…·");
            if (!key) return alert("è«‹å…ˆå¡«å¯« API Key ä»¥é€²è¡Œé©—è­‰");

            const statusDiv = document.getElementById(statusId);
            const btn = document.getElementById(btnId);

            statusDiv.innerText = "ğŸ” æª¢æŸ¥ä¸­...";
            btn.disabled = true;

            // 1. FAST CHECK: If Type includes 'train', search local database first
            if (types.includes('train')) {
                const localTrain = findTrainCoords(name);
                if (localTrain) {
                    updateLastMileState(type, localTrain.name, `${localTrain.lat}, ${localTrain.lng}`);
                    statusDiv.innerHTML = `<span style="color:var(--success-color)">âœ… å·²é©—è­‰(æœ¬åœ°è³‡æ–™åº«): ${localTrain.name}</span>`;
                    btn.disabled = false;
                    return;
                }
            }

            // 2. AI CHECK
            const prompt = `è«‹å¹«æˆ‘æª¢æŸ¥å°ç£æ˜¯å¦å­˜åœ¨åç‚ºã€Œ${name}ã€çš„ã€Œ${types.join('æˆ–')}ã€ç«™é»ã€‚
è‹¥å­˜åœ¨ï¼Œè«‹å›å‚³å…¶ç·¯ç¶“åº¦ã€‚
è«‹å‹™å¿…åªå›å‚³ JSON æ ¼å¼ï¼š{"valid": true, "lat": 12.34, "lng": 56.78, "correctName": "æ›´ç²¾ç¢ºçš„åç¨±"}
è‹¥ä¸å­˜åœ¨ï¼Œå›å‚³ {"valid": false}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, ''));

                if (json.valid) {
                    updateLastMileState(type, json.correctName || name, `${json.lat}, ${json.lng}`);
                    statusDiv.innerHTML = `<span style="color:var(--success-color)">âœ… å·²é©—è­‰: ${json.correctName} (${json.lat},${json.lng})</span>`;
                } else {
                    statusDiv.innerHTML = `<span style="color:var(--danger-color)">âŒ æ‰¾ä¸åˆ°æ­¤ç«™é»ï¼Œè«‹æª¢æŸ¥åç¨±</span>`;
                    // We don't verify coords if failed, but we keep name
                    if (type === 'work') state.settings.workLastMile.coords = null;
                    else state.settings.homeLastMile.coords = null;
                }
            } catch (e) {
                statusDiv.innerText = "é©—è­‰ç™¼ç”ŸéŒ¯èª¤: " + e.message;
            } finally {
                btn.disabled = false;
            }
        }

        function updateLastMileState(type, name, coords) {
            if (type === 'work') {
                state.settings.workLastMile.name = name;
                state.settings.workLastMile.coords = coords;
                document.getElementById('settingWorkStation').value = name;
            } else {
                state.settings.homeLastMile.name = name;
                state.settings.homeLastMile.coords = coords;
                document.getElementById('settingHomeStation').value = name;
            }
        }

        // Helper to find train in STATION_DATA structure
        function findTrainCoords(query) {
            const data = STATION_DATA['train'];
            if (!data) return null;

            let result = null;
            // Search all regions
            Object.values(data).forEach(list => {
                list.forEach(item => {
                    // item is {name, lat, lng}
                    if (item.name === query || item.name.includes(query)) {
                        // Prefer exact match, or first partial
                        if (!result || item.name === query) result = item;
                    }
                });
            });
            return result;
        }

        function checkKeyStatus() {
            const btn = document.getElementById('sendBtn');
            if (state.settings.apiKey) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
                btn.innerText = "è«‹å…ˆè¨­å®š API Key (åœ¨å·¦å´é¸å–®)";
            }
        }

        function checkSettingsAndPrompt() {
            const s = state.settings;
            // Check if any critical setting is missing
            const missingApiKey = !s.apiKey;
            const missingWork = !s.workLastMile || !s.workLastMile.name;
            const missingHome = !s.homeLastMile || !s.homeLastMile.name;

            if (missingApiKey || missingWork || missingHome) {
                console.log("Settings incomplete, opening modal...");
                openSettings(); // This function is already defined
            }
        }

        // --- Modal & Main Logic ---
        let currentModalType = '';
        let currentCategory = ''; // Top level (City)

        // Global variables for Selection Mode
        let selectionMode = 'manage'; // 'manage', 'select'
        let selectionTarget = null;   // 'work', 'home' (for Last Mile)

        function openSourceSelectModal(target) {
            selectionTarget = target;
            document.getElementById('sourceSelectModal').classList.add('active');
        }

        async function openStationModal(type, mode = 'manage') {
            currentModalType = type;
            selectionMode = mode;

            const modal = document.getElementById('stationModal');
            modal.classList.add('active');

            // Adjust Z-Index based on mode to sit on top of Settings/SourceSelect
            modal.style.zIndex = mode === 'select' ? '3000' : '';

            // Auto-fetch YouBike data if not loaded
            if (type === 'bike' && Object.keys(STATION_DATA['bike']).length === 0) {
                const modalTitle = document.getElementById('modalTitle');
                const originalTitle = modalTitle.innerText;
                modalTitle.innerText = "æ­£åœ¨è¼‰å…¥ YouBike è³‡æ–™...";
                await fetchYouBikeData();
                modalTitle.innerText = mode === 'select' ? "é¸æ“‡ YouBike ç«™é»" : "æ–°å¢ YouBike";
            }

            const titleMap = { train: 'ç«è»Š', mrt: 'æ·é‹', bus: 'å…¬è»Š', bike: 'YouBike' };
            const action = mode === 'select' ? 'é¸æ“‡' : 'æ–°å¢';
            document.getElementById('modalTitle').innerText = `${action}${titleMap[type]}`;

            const sidebar = document.getElementById('modalSidebar');
            sidebar.innerHTML = '';

            // Added List Link (Only in Manage Mode)
            if (mode === 'manage') {
                const added = document.createElement('div');
                added.className = 'category-item';
                added.innerText = 'å·²æ–°å¢åˆ—è¡¨';
                added.onclick = () => selectCategory('ADDED');
                sidebar.appendChild(added);
            }

            // Categories from DATA
            const data = STATION_DATA[type];
            if (data && Object.keys(data).length > 0) {
                Object.keys(data).forEach(k => {
                    const div = document.createElement('div');
                    div.className = 'category-item';
                    div.innerText = k;
                    div.onclick = () => selectCategory(k);
                    sidebar.appendChild(div);
                });
                selectCategory(Object.keys(data)[0]);
            } else {
                if (mode === 'manage') selectCategory('ADDED');
            }

            // Search init
            document.getElementById('modalSearch').value = '';
            document.getElementById('modalSearch').oninput = (e) => filterStations(e.target.value);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            // Active style
            document.querySelectorAll('#modalSidebar .category-item').forEach(el => {
                el.classList.toggle('active', el.innerText === (cat === 'ADDED' ? 'å·²æ–°å¢åˆ—è¡¨' : cat));
            });

            if (cat === 'ADDED') {
                renderGrid(state[currentModalType]);
                return;
            }

            const data = STATION_DATA[currentModalType][cat] || [];

            // Check if nested (City -> Line -> Stations) or flat (City -> Stations)
            if (Array.isArray(data)) {
                renderGrid(data);
            } else if (typeof data === 'object') {
                renderSubCategoryGrid(data);
            }
        }

        // Render "Folder" view for Lines
        function renderSubCategoryGrid(subData) {
            const grid = document.getElementById('modalGrid');
            grid.innerHTML = '';

            // subData keys are Line Names
            Object.keys(subData).forEach(lineName => {
                const div = document.createElement('div');
                div.className = 'grid-item';
                div.style.background = 'rgba(56, 189, 248, 0.15)'; // Distinct color
                div.style.borderColor = 'var(--accent-color)';
                div.innerText = lineName;
                div.innerHTML += '<span style="display:block;font-size:0.8em;color:#aaf">ğŸ“‚ é»æ“ŠæŸ¥çœ‹ç«™é»</span>';

                div.onclick = () => renderGrid(subData[lineName]);
                grid.appendChild(div);
            });
        }

        function renderGrid(items) {
            const grid = document.getElementById('modalGrid');
            grid.innerHTML = '';

            if (!items || items.length === 0) {
                grid.innerHTML = '<span style="color:#666; grid-column:1/-1; text-align:center;">ç„¡è³‡æ–™</span>';
                return;
            }

            items.forEach(item => {
                const name = item.name || item; // handle mixed
                const div = document.createElement('div');
                div.className = 'grid-item';
                div.innerText = name;
                if (item.lat || (typeof item === 'object' && item.lat)) {
                    div.innerHTML += '<span style="display:block;font-size:0.7em;color:gray">ğŸ“</span>';
                }

                // Selected state
                if (state[currentModalType].some(s => (s.name || s) === name)) {
                    div.classList.add('selected');
                }

                div.onclick = () => toggleStation(item);
                grid.appendChild(div);
            });
        }

        function toggleStation(item) {
            // Check Selection Mode
            if (selectionMode === 'select') {
                selectLastMileStation(item, currentModalType);
                return;
            }

            const list = state[currentModalType];
            const name = item.name || item;
            const idx = list.findIndex(s => (s.name || s) === name);

            if (idx >= 0) {
                list.splice(idx, 1);
            } else {
                // Ensure object structure
                list.push(typeof item === 'object' ? item : { name: item, lat: null, lng: null });
            }

            saveState();
            renderAllStations();

            // Refresh logic: if searching, re-filter; if in sub-cat, re-render?
            // Simple approach: if search active, refresh search. 
            // If normal view, we need to know if we are in Grid or SubGrid.
            // But 'toggleStation' only happens in Grid (Leaf). So we can just re-apply selection style or re-render.
            // Re-rendering entire grid is easiest but might lose scroll. 
            // Let's just toggle class for instant feedback if we are in Grid view.
            if (document.getElementById('modalSearch').value) {
                filterStations(document.getElementById('modalSearch').value);
            } else {
                // We don't know easily which specific list we are viewing without state tracking.
                // But generally users click, it toggles.
                // Let's just re-trigger the click (visual update) or simple re-render.
                // Since 'renderGrid' takes 'items', and we don't have 'items' stored globally...
                // We'll trust the user sees the border change. 
                // Actually, let's just re-run the render logic if we knew the context.
                // Given complexity, let's just manually update the class of the clicked element?
                // Hard to get the element reference here. 
                // Let's brute force re-render if we can. 
                // Issue: We don't know "current items". 
                // Let's just update ALL grid items' class based on state.
                updateGridSelection();
            }
        }

        }

        function selectLastMileStation(item, type) {
            const name = item.name || item;
            // Format: "StationName (Type)"
            const typeLabel = { train: 'ç«è»Š', mrt: 'æ·é‹', bus: 'å…¬è»Š', bike: 'YouBike' }[type] || type;
            const formattedName = `${name} (${typeLabel})`;

            // Determine Target Input based on selectionTarget ('work' or 'home')
            const inputId = selectionTarget === 'work' ? 'settingWorkStation' : 'settingHomeStation';
            const checkName = selectionTarget === 'work' ? 'workLmTrans' : 'homeLmTrans';

            // 1. Set Name
            document.getElementById(inputId).value = formattedName;

            // 2. Auto-Check corresponding transport type
            document.querySelectorAll(`input[name="${checkName}"]`).forEach(cb => {
                if (cb.value === type) cb.checked = true;
            });

            // 3. Store Coords if available
            // Note: We need to rely on 'saveSettings' to persist the name, 
            // but we can pre-fill the internal status/coords state if we want validateLastMile to work cleanly?
            // Actually, validateLastMile checks the INPUT value. 
            // BUT, if we have coordinates here, we should probably set them directly!
            // Let's do a "Soft Verify" - update the internal setting state immediately so the user sees "Verified"?
            // Or just fill input and let user click verify? 
            // User requirement: "é¸æ“‡å¾Œåœ¨æœ€å¾Œä¸€å“©è·¯ä¸Šé¡¯ç¤º..."
            // Let's update the internal validation state if we have coords.

            if (item.lat && item.lng) {
                const statusId = selectionTarget === 'work' ? 'workStatus' : 'homeStatus';
                const statusDiv = document.getElementById(statusId);
                statusDiv.innerHTML = `<span style="color:var(--success-color)">âœ… å·²é¸å–: ${name} (${item.lat}, ${item.lng})</span>`;

                // We can also potentially update the temp state if we want bypass 'Verify' button
                // But typically saveSettings reads from Input.
            }

            // Close Modals
            closeModal('stationModal');
            closeModal('sourceSelectModal');
        }

        function updateGridSelection() {
            if (selectionMode === 'select') return; // Selection Mode doesn't use toggle style in the same way (just clicks)

            const list = state[currentModalType];
            document.querySelectorAll('#modalGrid .grid-item').forEach(div => {
                // Text could have extra HTML, so check strict content or store data-name
                // Simpler: iterate rendered items? No.
                // We used innerText = name.
                // Let's match by innerText (ignoring the span)
                const text = div.innerText.split('\n')[0]; // name
                if (list.some(s => (s.name || s) === text)) {
                    div.classList.add('selected');
                } else {
                    div.classList.remove('selected');
                }
            });
        }

        function filterStations(query) {
            const grid = document.getElementById('modalGrid');
            grid.innerHTML = '';
            document.getElementById('clearSearchBtn').style.display = query ? 'block' : 'none';

            if (!query) {
                selectCategory(currentCategory);
                return;
            }

            // Recursive Search
            const searchIn = (objOrArray) => {
                let res = [];
                if (Array.isArray(objOrArray)) {
                    objOrArray.forEach(item => {
                        const n = item.name || item;
                        if (n.includes(query)) res.push(item);
                    });
                } else {
                    // Object (Lines or Cities)
                    Object.values(objOrArray).forEach(val => {
                        res = res.concat(searchIn(val));
                    });
                }
                return res;
            };

            const data = STATION_DATA[currentModalType] || {};
            const matches = searchIn(data);

            // Render matches
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'grid-item';
                div.innerText = m.name || m;
                if (state[currentModalType].some(s => (s.name || s) === (m.name || m))) {
                    div.classList.add('selected');
                }
                div.onclick = () => toggleStation(m);
                grid.appendChild(div);
            });

            // AI Search trigger
            const aiBtn = document.createElement('div');
            aiBtn.className = 'grid-item';
            aiBtn.style.color = 'var(--accent-color)';
            aiBtn.style.borderColor = 'var(--accent-color)';
            aiBtn.innerText = `ğŸ” AI æœå°‹ "${query}"`;
            aiBtn.style.gridColumn = '1 / -1';
            aiBtn.onclick = () => askGeminiForStations(query);
            grid.appendChild(aiBtn);
        }

        function renderAllStations() {
            ['train', 'mrt', 'bus', 'bike'].forEach(type => {
                const container = document.getElementById(`${type}-list`);
                container.innerHTML = '';
                state[type].forEach((s, idx) => {
                    const div = document.createElement('div');
                    div.className = 'station-tag';
                    div.innerHTML = `${s.name || s} <span class="remove-icon" onclick="removeStation('${type}', ${idx})">Ã—</span>`;
                    container.appendChild(div);
                });
            });
        }

        function removeStation(type, idx) {
            if (confirm('åˆªé™¤æ­¤ç«™é»ï¼Ÿ')) {
                state[type].splice(idx, 1);
                saveState();
                renderAllStations();
            }
        }

        function clearSearch() {
            document.getElementById('modalSearch').value = '';
            filterStations('');
        }

        // --- HYBRID SEARCH LOGIC ---
        let youbikeCache = [];

        const YOUBIKE_AREA_MAP = {
            "01": "è‡ºåŒ—å¸‚", "02": "æ–°åŒ—å¸‚", "03": "æ¡ƒåœ’å¸‚",
            "04": "æ–°ç«¹å¸‚", "05": "æ–°ç«¹ç¸£", "06": "è‡ºä¸­å¸‚",
            "07": "è‹—æ —ç¸£", "08": "å˜‰ç¾©å¸‚", "09": "å˜‰ç¾©ç¸£",
            "10": "è‡ºå—å¸‚", "11": "é«˜é›„å¸‚", "12": "å±æ±ç¸£"
        };

        async function fetchYouBikeData() {
            if (youbikeCache.length > 0) return youbikeCache;

            console.log("Fetching YouBike Data...");
            const stations = [];

            try {
                // Unified API for all regions
                const res = await fetch('https://apis.youbike.com.tw/json/station-min-yb2.json');
                const data = await res.json();

                // Reset STATION_DATA['bike'] to empty object to populate hierarchies
                // Note: STATION_DATA is global, we need to be careful.
                STATION_DATA['bike'] = {};

                data.forEach(s => {
                    // Filter invalid coordinates
                    if (!s.lat || !s.lng) return;

                    const areaCode = s.area_code_2;
                    const city = YOUBIKE_AREA_MAP[areaCode] || "å…¶ä»–åœ°å€";
                    const district = s.district_tw || "å…¶ä»–å€";
                    const name = s.name_tw.replace('YouBike2.0_', '');

                    // 1. Structure for Modal (City -> District -> Stations)
                    if (!STATION_DATA['bike'][city]) STATION_DATA['bike'][city] = {};
                    if (!STATION_DATA['bike'][city][district]) STATION_DATA['bike'][city][district] = [];

                    const stationObj = { name: name, lat: s.lat, lng: s.lng, region: city };
                    STATION_DATA['bike'][city][district].push(stationObj);

                    // 2. Flat list for AI Search
                    stations.push(stationObj);
                });

                console.log("YouBike Data Structured:", Object.keys(STATION_DATA['bike']));

            } catch (e) {
                console.error("YouBike API Error:", e);
                // Fallback or alert? For now just log.
            }

            youbikeCache = stations;
            console.log(`Loaded ${stations.length} YouBike stations.`);
            return stations;
        }

        async function askGeminiForStations(query) {
            const grid = document.getElementById('modalGrid');
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--accent-color);">
                ğŸ” æ­£åœ¨æœå°‹å®˜æ–¹å³æ™‚è³‡æ–™åº«...<br>
                <span style="font-size:0.8em; color:#888;">æŸ¥è©¢ "YouBike ${query}"</span>
            </div>`;

            // --- STEP 1: Official API Search ---
            try {
                const stations = await fetchYouBikeData();
                const q = query.trim();
                const terms = q.split(' ').filter(t => t.trim().length > 0);

                // Helper: Calculate Match Score
                // Score = (Number of matching chars) / (Total chars in query)
                const getScore = (stationName) => {
                    const name = stationName.toLowerCase();
                    // 1. Strict Include check (High Score)
                    if (terms.every(t => name.includes(t.toLowerCase()))) return 1.0;

                    // 2. Fuzzy Char check
                    // Check how many characters from query exist in station name (in order? no, just set)
                    // Let's use simple set intersection count for robustness against "å¤§å…¨è¯" vs "å…¨è¯"
                    const queryChars = q.replace(/\s/g, '').toLowerCase().split('');
                    let matchCount = 0;
                    queryChars.forEach(char => {
                        if (name.includes(char)) matchCount++;
                    });

                    return matchCount / queryChars.length;
                };

                // Filter & Sort
                // Threshold: > 0.6 (60% match)
                const matches = stations
                    .map(s => ({ ...s, score: getScore(s.name) }))
                    .filter(s => s.score > 0.6)
                    .sort((a, b) => b.score - a.score);

                if (matches.length > 0) {
                    grid.innerHTML = '';
                    matches.slice(0, 10).forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'grid-item';
                        div.style.borderColor = 'var(--success-color)';
                        // Show Name + Match Reason (e.g. "å®˜æ–¹è³‡æ–™")
                        div.innerHTML = `ğŸš² ${m.name}<br><span style="font-size:0.7em;color:#666">${m.region} (å®˜æ–¹)</span>`;
                        div.onclick = () => {
                            toggleStation(m);
                            document.getElementById('modalSearch').value = '';
                            selectCategory('ADDED');
                            alert(`âœ… å·²æ–°å¢å®˜æ–¹ç«™é»: ${m.name}`);
                        };
                        grid.appendChild(div);
                    });

                    if (matches.length > 10) {
                        const more = document.createElement('div');
                        more.style.gridColumn = '1/-1';
                        more.style.textAlign = 'center';
                        more.style.color = '#888';
                        more.innerText = `(é‚„æœ‰ ${matches.length - 10} ç­†çµæœï¼Œè«‹è¼¸å…¥æ›´ç²¾ç¢ºçš„é—œéµå­—)`;
                        grid.appendChild(more);
                    }
                    return; // Stop here, don't use AI
                }

            } catch (e) {
                console.error("Official Search Failed", e);
            }

            // --- STEP 2: AI Fallback ---
            const key = state.settings.apiKey;
            if (!key) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--danger-color);">âŒ å®˜æ–¹è³‡æ–™åº«æ‰¾ä¸åˆ°ï¼Œä¸”æœªè¨­å®š API Key ç„¡æ³•ä½¿ç”¨ AI æœå°‹</div>`;
                return;
            }

            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--accent-color);">
                ğŸ¤– å®˜æ–¹è³‡æ–™åº«ç„¡çµæœï¼Œè½‰ç”± AI æœå°‹...<br>
                <span style="font-size:0.8em; color:#888;">"${query}"</span>
            </div>`;

            const prompt = `è«‹å¹«æˆ‘æŸ¥è©¢å°ç£åœ°é»ã€Œ${query}ã€çš„ç²¾ç¢ºç¶“ç·¯åº¦ã€‚
è«‹å‹™å¿…ç¢ºèªè©²åœ°é»æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç‚ºé€£é–åº—è«‹ç¢ºèªè©²åˆ†åº—æ˜¯å¦å­˜åœ¨ã€‚
è«‹å›å‚³ JSON æ ¼å¼ï¼š{"valid": true, "name": "å®˜æ–¹æˆ–æ›´ç²¾ç¢ºåç¨±", "lat": 25.123, "lng": 121.123}
è‹¥æ‰¾ä¸åˆ°æˆ–ä¸ç¢ºå®šï¼Œè«‹å›å‚³ {"valid": false, "error": "æ‰¾ä¸åˆ°æ­¤åœ°é»"}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, ''));

                if (!json.valid) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--danger-color);">âŒ AI ä¹Ÿæ‰¾ä¸åˆ°: ${json.error || 'æœªçŸ¥åŸå› '}</div>`;
                } else {
                    // Success
                    toggleStation({ name: json.name, lat: json.lat, lng: json.lng });
                    document.getElementById('modalSearch').value = '';
                    selectCategory('ADDED');
                    alert(`âœ… AI å·²æ–°å¢: ${json.name} (æ³¨æ„: AI è³‡æ–™å¯èƒ½ä¸å®Œå…¨æº–ç¢º)`);
                }
            } catch (e) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--danger-color);">âŒç™¼ç”ŸéŒ¯èª¤: ${e.message}</div>`;
            }
        }

        function updatePromptPreview() {
            const nowHour = new Date().getHours();
            const isGoingWork = nowHour < 12;

            let text = `(ç¯„ä¾‹) ç¾åœ¨æ˜¯ ${isGoingWork ? 'æ—©ä¸Š(ä¸Šç­)' : 'ä¸‹åˆ(ä¸‹ç­)'}ã€‚\n`;
            text += `å•Ÿç”¨çš„äº¤é€šå·¥å…·: ${isGoingWork ? state.settings.workTrans.join(', ') : state.settings.homeTrans.join(', ')}`;

            // Preview Last Mile
            const lm = isGoingWork ? state.settings.workLastMile : state.settings.homeLastMile;
            if (lm && lm.name) {
                text += `\nğŸ çµ‚é»ç«™: ${lm.name} (${lm.trans.join('/')})`;
            }

            document.getElementById('promptPreview').value = text;
        }

        async function askGemini() {
            const now = new Date();
            const nowHour = now.getHours();

            let context = "general";
            let allowedTrans = ["train", "mrt", "bus", "bike"];

            // Determine context
            if (nowHour < 12) {
                context = "ä¸Šç­";
                allowedTrans = state.settings.workTrans;
            } else {
                context = "ä¸‹ç­";
                allowedTrans = state.settings.homeTrans;
            }

            const gps = await getGPS();

            let startLocationStr = `æˆ‘çš„ç›®å‰ä½ç½®: ${gps}`;
            // GPS Fallback Logic
            if (gps === "ç„¡GPS" || gps === "GPSå¤±æ•—") {
                let inferredStart = "";
                // Logic: If going to work, start from Home. If going home, start from Work.
                if (context === "ä¸Šç­") {
                    inferredStart = state.settings.homeLastMile.name;
                } else {
                    inferredStart = state.settings.workLastMile.name;
                }

                if (inferredStart) {
                    startLocationStr = `(æ³¨æ„: ç„¡æ³•å–å¾— GPS) è«‹å‡è¨­æˆ‘å¾ã€Œ${inferredStart}ã€å‡ºç™¼`;
                } else {
                    startLocationStr = `(æ³¨æ„: ç„¡æ³•å–å¾— GPS ä¸”ç„¡é è¨­èµ·é»)`;
                }
            }

            let trainPrompt = allowedTrans.includes("train") ? state.train.map(s => s.name).join(',') : "ä¸æŸ¥è©¢";
            let mrtPrompt = allowedTrans.includes("mrt") ? state.mrt.map(s => s.name).join(',') : "ä¸æŸ¥è©¢";
            let busPrompt = allowedTrans.includes("bus") ? state.bus.map(s => s.name).join(',') : "ä¸æŸ¥è©¢";
            let bikePrompt = allowedTrans.includes("bike") ? state.bike.map(s => s.name).join(',') : "ä¸æŸ¥è©¢";

            // ADD LAST MILE INFO
            let lastMileInfo = "";
            let destinationName = "";
            const lm = (context === "ä¸Šç­") ? state.settings.workLastMile : state.settings.homeLastMile;
            if (lm && lm.name) {
                destinationName = lm.name;
                lastMileInfo = `\n[é‡è¦] æœ€çµ‚ç›®çš„åœ°è«‹å°èˆªè‡³ã€Œ${lm.name}ã€(${lm.trans.join('æˆ–')})ã€‚`;
                // If Coords info, add it
                if (lm.coords) {
                    lastMileInfo += ` è©²ç«™åº§æ¨™ç‚º: ${lm.coords}`;
                }
            } else {
                destinationName = context === "ä¸Šç­" ? "å…¬å¸" : "å®¶";
            }

            const prompt = `ç¾åœ¨æ™‚é–“ ${now.toLocaleString()}, æˆ‘æ­£è¦${context}ã€‚
${startLocationStr}ã€‚ç›®çš„åœ°: ${destinationName}ã€‚${lastMileInfo}

è«‹å¹«æˆ‘æŸ¥è©¢ **æœªä¾† 2 å°æ™‚å…§** çš„äº¤é€šè³‡è¨Šã€‚
è«‹å‹™å¿…ä½¿ç”¨ Google Search æˆ–å³æ™‚è³‡æ–™ä¾†ç²å–æœ€æ–°çš„ç­æ¬¡æ™‚é–“ (Real-time)ã€‚

è«‹ä¾æ“šæˆ‘çš„äº¤é€šåå¥½æä¾›å»ºè­°ï¼š
1. ç«è»Š (é—œæ³¨: ${trainPrompt})
2. æ·é‹ (é—œæ³¨: ${mrtPrompt})
3. å…¬è»Š (é—œæ³¨: ${busPrompt})
4. YouBike (é—œæ³¨: ${bikePrompt})

ã€é‡è¦è«‹æ±‚ã€‘
è«‹é¡å¤–æä¾› 3 å€‹ã€Œæœ€ä½³è½‰ä¹˜æ–¹æ¡ˆã€(Integrated Itineraries)ï¼Œæ•´åˆä¸Šè¿°äº¤é€šå·¥å…·ï¼Œå‘Šè¨´æˆ‘å¦‚ä½•å¾ç›®å‰ä½ç½®åˆ°é”ç›®çš„åœ°ã€‚
ç›¡é‡åŒ…å«ï¼šæ­¥è¡Œ -> äº¤é€šå·¥å…·A -> äº¤é€šå·¥å…·B -> ç›®çš„åœ°ã€‚
éœ€åŒ…å«é ä¼°ç™¼è»Š/æŠµé”æ™‚é–“ã€‚

è«‹å›å‚³ JSON æ ¼å¼ (ä¸è¦ Markdown):
{
  "train": ["ç«è»Šè³‡è¨Š1", "ç«è»Šè³‡è¨Š2"],
  "mrt": ["æ·é‹è³‡è¨Š1", "æ·é‹è³‡è¨Š2"],
  "bus": ["å…¬è»Šè³‡è¨Š1", "å…¬è»Šè³‡è¨Š2"],
  "bike": ["YouBikeè³‡è¨Š1"],
  "itineraries": [
     { "title": "æ–¹æ¡ˆA (å…¬è»Š+æ·é‹)", "details": "10:00 æ­ 307 (å…¬é¤¨ç«™) -> 10:20 è½‰æ·é‹ -> 10:40 æŠµé”", "time": "40åˆ†" },
     { "title": "æ–¹æ¡ˆB (ç«è»Šç›´é”)", "details": "...", "time": "30åˆ†" },
     { "title": "æ–¹æ¡ˆC", "details": "...", "time": "..." }
  ],
  "misc": "å…¶ä»–ç°¡çŸ­å»ºè­°"
}`;

            callGeminiAPI(prompt);
        }

        function renderItineraries(list) {
            const div = document.getElementById('itinerary-result');
            div.innerHTML = '';
            if (!list || list.length === 0) {
                div.innerHTML = '<span style="color:#666">ç„¡å»ºè­°æ–¹æ¡ˆ</span>';
                return;
            }
            list.forEach(i => {
                const item = document.createElement('div');
                item.style.marginBottom = "15px";
                item.style.padding = "10px";
                item.style.background = "rgba(255,255,255,0.05)";
                item.style.borderRadius = "8px";

                item.innerHTML = `
                    <div style="color:var(--accent-color); font-weight:bold; margin-bottom:5px;">${i.title || 'æ–¹æ¡ˆ'} <span style="float:right; font-size:0.9em; color:#fff;">â± ${i.time || '?'}</span></div>
                    <div style="font-size:0.9em; color:#ddd;">${i.details || ''}</div>
                `;
                div.appendChild(item);
            });
        }

        async function getGPS() {
            return new Promise(r => {
                if (!navigator.geolocation) r("ç„¡GPS");
                navigator.geolocation.getCurrentPosition(
                    p => r(`${p.coords.latitude.toFixed(4)},${p.coords.longitude.toFixed(4)}`),
                    e => r("GPSå¤±æ•—")
                );
            });
        }

        async function callGeminiAPI(prompt) {
            const key = state.settings.apiKey;
            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerText = "ğŸ¤– æ€è€ƒä¸­...";

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;

                document.getElementById('responseArea').innerText = text;

                const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, ''));

                renderResult('train', json.train);
                renderResult('mrt', json.mrt);
                renderResult('bus', json.bus);
                renderResult('bike', json.bike);
                renderItineraries(json.itineraries);

            } catch (e) {
                alert("éŒ¯èª¤: " + e.message);
                document.getElementById('debugArea').style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸ“ æ ¹æ“šè¨­å®šå–å¾— GPS ä¸¦æŸ¥è©¢";
            }
        }

        function renderResult(type, list) {
            const div = document.getElementById(`${type}-result`);
            div.innerHTML = '';
            if (!list || list.length === 0) {
                div.innerHTML = '<span style="color:#666">ç„¡å»ºè­°</span>';
                return;
            }
            list.forEach(t => {
                const d = document.createElement('div');
                d.innerText = t;
                d.style.padding = "5px 0";
                d.style.borderBottom = "1px solid #333";
                div.appendChild(d);
            });
        }

        async function askGeminiForStations(query) {
            const key = state.settings.apiKey;
            if (!key) return alert('è«‹åœ¨è¨­å®šä¸­è¼¸å…¥ API Key');
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('modalGrid').style.display = 'none';

            const prompt = `åˆ—å‡º 5 å€‹åŒ…å«ã€Œ${query}ã€çš„å°ç£è»Šç«™/ç«™ç‰Œ/YouBikeç«™
å›å‚³ JSON é™£åˆ—: [{"name": "èˆ‡è¼¸å…¥ç›¸é—œçš„å…¨å", "lat": 0.0, "lng": 0.0}]`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, ''));

                const grid = document.getElementById('modalGrid');
                grid.innerHTML = '';
                json.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'grid-item';
                    div.innerText = item.name;
                    div.innerHTML += '<span style="display:block;font-size:0.7em;color:gray">ğŸ“</span>';
                    div.onclick = () => toggleStation(item);
                    grid.appendChild(div);
                });
            } catch (e) {
                alert(e.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('modalGrid').style.display = 'grid';
            }
        }

        function toggleDebug() {
            const d = document.getElementById('debugArea');
            d.style.display = d.style.display === 'none' ? 'block' : 'none';
        }

    </script>
</body>

</html>