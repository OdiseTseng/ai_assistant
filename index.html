<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Odise's Personal Gemini Assistant">
    <title>Odise Gemini Assistant</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --accent-color: #38bdf8;
            --accent-hover: #0ea5e9;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --input-bg: rgba(15, 23, 42, 0.8);
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 70%);
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* 2x2 Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* For key input area at the top */
        .header-controls {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        h2 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Station Buttons Container */
        .station-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        /* Result Box Style */
        .result-box {
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
            min-height: 20px;
        }

        /* Buttons */
        button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .btn-add {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
            border: 1px dashed var(--accent-color);
        }

        .btn-add:hover {
            background-color: var(--accent-color);
            color: #fff;
        }

        .station-tag {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: default;
            position: relative;
        }

        .station-tag .remove-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
        }

        .station-tag .remove-icon:hover {
            color: #ffadad;
        }

        /* Inputs */
        input[type="password"],
        textarea,
        input[type="text"],
        input[type="search"] {
            background-color: var(--input-bg);
            border: 1px solid var(--card-border);
            color: var(--text-color);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
        }

        /* Prompt Area */
        .prompt-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prompt-area textarea {
            flex-grow: 1;
            min-height: 150px;
            resize: vertical;
        }

        /* Action Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            margin-top: 10px;
        }

        .btn-primary:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Response Area */
        .response-card {
            grid-column: 1 / -1;
            min-height: 100px;
        }

        #responseArea {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        /* Version Footer */
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 0.8rem;
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 41, 59, 0.95);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-color);
        }

        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .modal-sidebar {
            width: 30%;
            border-right: 1px solid var(--card-border);
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.5);
        }

        .modal-main {
            width: 70%;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .category-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .category-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .category-item.active {
            background: var(--accent-color);
            color: white;
        }

        .search-bar {
            margin-bottom: 15px;
        }

        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }

        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            font-size: 0.95rem;
            position: relative;
            /* For Pseudo-element */
        }

        .grid-item:hover {
            border-color: var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
        }

        .grid-item.selected {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .grid-item.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .coord-hint {
            display: block;
            font-size: 0.7em;
            color: #64748b;
            margin-top: 4px;
        }

        .input-group-modal {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: #8b949e;
        }

        .modal-close:hover {
            color: white;
            background: transparent;
            transform: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .modal-body {
                flex-direction: column;
            }

            .modal-sidebar {
                width: 100%;
                height: 30%;
                border-right: none;
                border-bottom: 1px solid var(--card-border);
            }

            .modal-main {
                width: 100%;
                height: 70%;
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-grid">
        <!-- API Key Header -->
        <div class="header-controls">
            <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Š Google AI Studio API Key">
            <button onclick="saveKey()" style="background: var(--success-color); border:none; color:white;">å„²å­˜</button>
            <button onclick="clearKey()">æ¸…é™¤</button>
        </div>

        <!-- Section 1: Train -->
        <div class="card">
            <h2>ğŸš„ ç«è»Šæ™‚åˆ»è¡¨ <button class="btn-add" onclick="openModal('train')">+</button></h2>
            <div id="train-list" class="station-list"></div>
            <div id="train-result" class="result-box"></div>
        </div>

        <!-- Section 2: Bus -->
        <div class="card">
            <h2>ğŸšŒ å…¬è»Šæ™‚åˆ»è¡¨ <button class="btn-add" onclick="openModal('bus')">+</button></h2>
            <div id="bus-list" class="station-list"></div>
            <div id="bus-result" class="result-box"></div>
        </div>

        <!-- Section 3: YouBike -->
        <div class="card">
            <h2>ğŸš² YouBike ç«™é» <button class="btn-add" onclick="openModal('bike')">+</button></h2>
            <div id="bike-list" class="station-list"></div>
            <div id="bike-result" class="result-box"></div>
        </div>

        <!-- Section 4: Custom Prompt -->
        <div class="card">
            <h2>ğŸ“ è‡ªå®šç¾©æç¤ºè©</h2>
            <div class="prompt-area">
                <textarea id="promptTemplate" placeholder="è¼¸å…¥æç¤ºè©æ¨¡ç‰ˆ..."></textarea>
                <button id="sendBtn" onclick="askGemini()" class="btn-primary" disabled>
                    å–å¾— GPS ä¸¦ç™¼é€æŸ¥è©¢
                </button>
            </div>
        </div>

        <!-- Section 5: Info / Response -->
        <div class="header-controls" style="grid-column: 1 / -1; justify-content: space-between; align-items: center;">
            <div id="statusText">ç‹€æ…‹ï¼šç­‰å¾…æ“ä½œ...</div>
            <button onclick="toggleDebug()" class="btn-secondary" style="width: auto;">â„¹ï¸ è©³ç´°è³‡è¨Š</button>
        </div>

        <div id="debugArea" class="card response-card" style="display: none;">
            <h2>ğŸ¤– åŸå§‹å›æ‡‰ (Debug)</h2>
            <div id="responseArea"></div>
        </div>

        <!-- Footer -->
        <div class="footer" id="versionInfo"></div>
    </div>

    <!-- MODAL -->
    <div id="stationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" style="white-space: nowrap; margin-right: 15px;">æ–°å¢ç«™é»</h3>

                <!-- Expanded Header Search Area -->
                <div style="flex-grow: 1; display: flex; gap: 5px; position: relative;">
                    <input type="text" id="modalSearch" class="search-bar" style="margin: 0;"
                        placeholder="æœå°‹ç«™é» (ä¾‹å¦‚: æ¿æ©‹, 307)...">
                    <button id="clearSearchBtn" onclick="clearSearch()"
                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.1); border: 1px solid var(--card-border); border-radius: 4px; padding: 2px 8px; color: var(--text-color); display: none; cursor:pointer; font-size: 12px;">Clear</button>
                </div>

                <button class="modal-close" onclick="closeModal()" style="margin-left: 15px;">Ã—</button>
            </div>

            <div class="modal-body">
                <!-- Left Sidebar -->
                <div class="modal-sidebar" id="modalSidebar">
                    <!-- Categories -->
                </div>
                <!-- Right Main Area -->
                <div class="modal-main">
                    <div id="loadingIndicator"
                        style="display:none; text-align: center; color: var(--accent-color); padding: 20px;">
                        ğŸ¤– AI æœå°‹ä¸­...
                    </div>
                    <div id="modalGrid" class="station-grid">
                        <!-- Stations -->
                    </div>
                    <div id="modalHelpText"
                        style="margin-top: auto; padding-top: 15px; color: #64748b; font-size: 0.85em;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="version.js"></script>
    <script src="station_data.js"></script>
    <script>
        // --- State Management ---
        const DEFAULT_PROMPT = `ç¾åœ¨æ™‚é–“ {TIME}ï¼Œä½ç½® {GPS}ã€‚
è«‹å”åŠ©æŸ¥è©¢ä»¥ä¸‹äº¤é€šè³‡è¨Šï¼Œä¸¦å‹™å¿…ä»¥ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦åŒ…å« Markdown æ¨™è¨˜ (\`\`\`json)ã€‚
éœ€è¦æŸ¥è©¢çš„ç«™é»ï¼š
1. ç«è»Šï¼š{TRAIN_LIST}
2. å…¬è»Šï¼š{BUS_LIST}
3. YouBikeï¼š{BIKE_LIST}

JSON æ ¼å¼è¦æ±‚ï¼š
{
  "train": ["ç«™é»A: è³‡è¨Š...", "ç«™é»B: è³‡è¨Š..."],
  "bus": ["è·¯ç·šA: è³‡è¨Š..."],
  "bike": ["ç«™é»A: å¯å€Ÿ/å¯é‚„..."],
  "misc": "GPS æ¨è–¦æˆ–å…¶ä»–è£œå……è³‡è¨Š..."
}

è‹¥è©²é¡åˆ¥ç„¡æŸ¥è©¢é …ç›®æˆ–ç„¡è³‡æ–™ï¼Œè«‹å›å‚³ç©ºé™£åˆ— []ã€‚
è«‹æ ¹æ“šæˆ‘ç›®å‰çš„ GPS ä½ç½®ï¼Œæ¨è–¦è·é›¢æœ€è¿‘çš„ä¸Šè¿°é¡åˆ¥ç«™é»å„ä¸€å€‹ï¼Œæ”¾å…¥ misc æ¬„ä½ä¸­ã€‚`;

        const state = {
            train: JSON.parse(localStorage.getItem('user_stations_train')) || [],
            bus: JSON.parse(localStorage.getItem('user_stations_bus')) || [],
            bike: JSON.parse(localStorage.getItem('user_stations_bike')) || [],
            prompt: localStorage.getItem('user_prompt_template') || DEFAULT_PROMPT
        };

        // --- Init & Migration ---
        window.onload = function () {
            migrateData();
            checkKeyStatus();
            renderAllStations();
            document.getElementById('promptTemplate').value = state.prompt;

            // Version Info
            if (typeof BUILD_INFO !== 'undefined') {
                document.getElementById('versionInfo').innerText = `æœ€å¾Œæ›´æ–°ï¼š${BUILD_INFO.time}`;
                document.title = `Odise Gemini Assistant (${BUILD_INFO.time})`;
            }
        };

        function migrateData() {
            let changed = false;
            ['train', 'bus', 'bike'].forEach(type => {
                if (state[type] && state[type].length > 0) {
                    // Check if first item is string (legacy format)
                    if (typeof state[type][0] === 'string') {
                        state[type] = state[type].map(s => ({
                            name: s,
                            lat: null,
                            lng: null
                        }));
                        changed = true;
                    }
                }
            });
            if (changed) saveState();
        }

        function getStationName(station) {
            return station && typeof station === 'object' ? station.name : station;
        }

        // --- Station Dashboard Logic ---
        function renderAllStations() {
            renderList('train', state.train);
            renderList('bus', state.bus);
            renderList('bike', state.bike);
        }

        function renderList(type, list) {
            const container = document.getElementById(`${type}-list`);
            container.innerHTML = '';
            list.forEach((station, index) => {
                const tag = document.createElement('div');
                tag.className = 'station-tag';
                const name = getStationName(station);
                tag.innerHTML = `${name} <span class="remove-icon" onclick="removeStation('${type}', ${index})">Ã—</span>`;
                container.appendChild(tag);
            });
            if (list.length === 0) {
                container.innerHTML = '<span style="color: #64748b; font-size: 0.9em;">å°šç„¡ç«™é»ï¼Œè«‹é»æ“Š + æ–°å¢</span>';
            }
        }

        function removeStation(type, index) {
            const station = state[type][index];
            const name = getStationName(station);
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ "${name}" å—ï¼Ÿ`)) {
                state[type].splice(index, 1);
                saveState();
                renderAllStations();
            }
        }

        function saveState() {
            localStorage.setItem('user_stations_train', JSON.stringify(state.train));
            localStorage.setItem('user_stations_bus', JSON.stringify(state.bus));
            localStorage.setItem('user_stations_bike', JSON.stringify(state.bike));
        }

        document.getElementById('promptTemplate').addEventListener('input', (e) => {
            state.prompt = e.target.value;
            localStorage.setItem('user_prompt_template', state.prompt);
        });

        // --- MODAL & AI SEARCH LOGIC ---
        let currentModalType = '';
        let currentCategory = '';

        function openModal(type) {
            currentModalType = type;
            const titleMap = { train: 'æ–°å¢ç«è»Š', bus: 'æ–°å¢å…¬è»Š', bike: 'æ–°å¢ YouBike' };
            document.getElementById('modalTitle').innerText = titleMap[type];

            // Reset Search
            const searchInput = document.getElementById('modalSearch');
            searchInput.value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('modalHelpText').style.display = 'none';

            // Sidebar & Grid
            const sidebar = document.getElementById('modalSidebar');
            sidebar.innerHTML = '';

            // 1. Always add "Added Stations" Category
            const addedDiv = document.createElement('div');
            addedDiv.className = 'category-item';
            addedDiv.innerText = 'å·²æ–°å¢ç«™é»åˆ—è¡¨';
            addedDiv.onclick = () => selectCategory('ADDED_LIST');
            sidebar.appendChild(addedDiv);

            // 2. Generate Data Categories (Sidebar)
            const data = STATION_DATA[type];
            let hasData = false;
            if (data && Object.keys(data).length > 0) {
                hasData = true;
                Object.keys(data).forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'category-item';
                    div.innerText = cat;
                    div.onclick = () => selectCategory(cat);
                    sidebar.appendChild(div);
                });
            }

            // Default select
            if (hasData) {
                selectCategory(Object.keys(data)[0]);
            } else {
                selectCategory('ADDED_LIST');
            }

            // Add Search Listener
            searchInput.oninput = (e) => filterStations(e.target.value);

            document.getElementById('stationModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('stationModal').classList.remove('active');
        }

        function clearSearch() {
            document.getElementById('modalSearch').value = '';
            filterStations('');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            // Highlight sidebar
            document.querySelectorAll('.category-item').forEach(el => {
                const isMatch = (cat === 'ADDED_LIST' && el.innerText === 'å·²æ–°å¢ç«™é»åˆ—è¡¨') || el.innerText === cat;
                el.classList.toggle('active', isMatch);
            });

            // Help Text Logic
            const helpText = document.getElementById('modalHelpText');
            if (currentModalType === 'bike' || currentModalType === 'bus') {
                helpText.style.display = 'block';
                helpText.innerText = "ğŸ’¡ æç¤ºï¼šè«‹è¼¸å…¥å®Œæ•´çš„ç«™é»åç¨±ï¼Œä¾‹å¦‚ï¼šæ·é‹è‡ºåŒ—101/ä¸–è²¿ç«™(2è™Ÿå‡ºå£)";
            } else {
                helpText.style.display = 'none';
            }

            // Render grid
            if (cat === 'ADDED_LIST') {
                renderGrid(state[currentModalType]);
            } else {
                renderGrid(STATION_DATA[currentModalType][cat] || []);
            }
        }

        // --- Core Toggle Logic ---
        function createStationItem(station) {
            const div = document.createElement('div');
            div.className = 'grid-item';

            const name = getStationName(station);
            div.innerText = name;

            // Show GPS hint if available
            if (station.lat && station.lng) {
                const hint = document.createElement('span');
                hint.className = 'coord-hint';
                hint.innerText = 'ğŸ“'; // just a symbol for cleaner UI
                div.appendChild(hint);
            }

            const list = state[currentModalType];
            // Check existence by name
            if (list.some(s => getStationName(s) === name)) {
                div.classList.add('selected');
            }

            div.onclick = () => toggleStation(station);
            return div;
        }

        function toggleStation(station) {
            const list = state[currentModalType];
            const name = getStationName(station);
            const index = list.findIndex(s => getStationName(s) === name);

            if (index === -1) {
                // Add - ensure we store object
                const newStation = typeof station === 'object' ? station : { name: station, lat: null, lng: null };
                list.push(newStation);
            } else {
                // Remove
                list.splice(index, 1);
            }

            saveState();
            renderAllStations(); // Update dashboard

            // Refresh Modal View
            const searchVal = document.getElementById('modalSearch').value;
            if (searchVal) {
                filterStations(searchVal);
            } else if (currentCategory === 'ADDED_LIST') {
                selectCategory('ADDED_LIST');
            } else {
                selectCategory(currentCategory);
            }
        }

        function renderGrid(items) {
            const grid = document.getElementById('modalGrid');
            grid.innerHTML = '';

            if (!items || items.length === 0) {
                grid.innerHTML = '<div style="padding:15px; color:#64748b; font-size: 0.9em;">(è«‹æ–°å¢)</div>';
                return;
            }

            items.forEach(item => {
                grid.appendChild(createStationItem(item));
            });
        }

        function filterStations(query) {
            const grid = document.getElementById('modalGrid');
            document.getElementById('clearSearchBtn').style.display = query ? 'block' : 'none';
            grid.innerHTML = '';
            document.getElementById('modalHelpText').style.display = query ? 'none' : 'block';

            if (!query) {
                if (currentCategory === 'ADDED_LIST') {
                    selectCategory('ADDED_LIST');
                } else if (currentCategory && STATION_DATA[currentModalType] && STATION_DATA[currentModalType][currentCategory]) {
                    selectCategory(currentCategory);
                } else {
                    grid.innerHTML = '<div style="padding:20px; color:#64748b; width:100%; text-align:center;">è«‹è¼¸å…¥é—œéµå­—æœå°‹</div>';
                }
                return;
            }

            // 1. Local Fuzzy Search
            const data = STATION_DATA[currentModalType];
            let matches = []; // Array of objects
            if (data) {
                Object.values(data).forEach(list => {
                    list.forEach(item => {
                        const name = getStationName(item);
                        if (name.includes(query)) matches.push(item);
                    });
                });
            }

            // Removing duplicates if any names are same (not expected for train, but good practice)
            const unique = new Map();
            matches.forEach(m => unique.set(getStationName(m), m));

            unique.forEach(item => {
                grid.appendChild(createStationItem(item));
            });

            // 2. AI Search Option
            if (unique.size === 0 && query) {
                const aiSearch = document.createElement('div');
                aiSearch.className = 'grid-item';
                aiSearch.style.borderColor = 'var(--accent-color)';
                aiSearch.style.color = 'var(--accent-color)';
                aiSearch.style.gridColumn = "1 / -1";
                aiSearch.style.marginTop = "10px";
                aiSearch.innerText = `ğŸ” AI æœå°‹: å“ªäº›ç«™åŒ…å« "${query}"ï¼Ÿ`;
                aiSearch.onclick = () => askGeminiForStations(query);
                grid.appendChild(aiSearch);
            }
        }

        async function askGeminiForStations(query) {
            const key = localStorage.getItem('user_gemini_key');
            if (!key) return alert("è«‹å…ˆè¨­å®š API Key");

            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('modalGrid');

            grid.style.display = 'none';
            loading.style.display = 'block';

            try {
                let typeName = '';
                let extraInstruction = '';
                if (currentModalType === 'bus') {
                    typeName = 'å°ç£å…¬è»Šè·¯ç·šæˆ–ç«™ç‰Œ';
                } else if (currentModalType === 'bike') {
                    typeName = 'å°ç£ YouBike 2.0 ç«™é»';
                } else {
                    typeName = 'å°ç£ç«è»Šç«™é»';
                    extraInstruction = 'æ³¨æ„ï¼šè«‹ã€Œæ’é™¤ã€æ·é‹ç«™æˆ–è¼•è»Œç«™ï¼Œåªåˆ—å‡ºã€Œå°éµç«è»Šç«™ã€ã€‚';
                }

                const prompt = `è«‹åˆ—å‡º 5 å€‹åç¨±ä¸­åŒ…å«ã€Œ${query}ã€çš„ã€Œ${typeName}ã€ï¼Œä¸¦é™„ä¸Šè©²ç«™é»çš„ç·¯ç¶“åº¦ (latitude, longitude)ã€‚
${extraInstruction}
è«‹å‹™å¿…åªå›å‚³ JSON ç‰©ä»¶é™£åˆ— (Array of Objects)ï¼Œä¸è¦æœ‰ä»»ä½• Markdown æˆ–å…¶ä»–æ–‡å­—ã€‚
æ¬„ä½ï¼šname, lat, lng
ç¯„ä¾‹ï¼š[{"name": "è‡ºåŒ—", "lat": 25.0478, "lng": 121.5170}] (è‹¥æ˜¯æœªçŸ¥åº§æ¨™è«‹å¡« null)`;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                const text = data.candidates && data.candidates[0].content.parts[0].text;
                if (!text) throw new Error("ç„¡å›æ‡‰æ–‡å­—");

                const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
                let stations = [];
                try {
                    stations = JSON.parse(cleanJson);
                } catch (e) {
                    console.warn("Parsing failed", text);
                }

                grid.innerHTML = '';

                const header = document.createElement('div');
                header.style.gridColumn = "1 / -1";
                header.style.color = "var(--accent-color)";
                header.style.marginBottom = "5px";
                header.style.display = "flex";
                header.style.justifyContent = "space-between";
                header.innerHTML = `
                    <span>ğŸ¤– AI æœå°‹çµæœ ("${query}"):</span>
                    <button id="toggleDebugBtn" style="padding:2px 8px; font-size:12px; height:auto; background:rgba(255,255,255,0.1); border:1px solid #555; border-radius:4px; color:#aaa; cursor:pointer;">Info</button>
                    <div id="aiDebugRaw" style="display:none; width:100%; white-space:pre-wrap; background:rgba(0,0,0,0.3); padding:5px; margin-top:5px; font-size:0.8em; color:#ccc;"></div>
                `;

                header.querySelector('#aiDebugRaw').innerText = text;
                header.querySelector('#toggleDebugBtn').onclick = (e) => {
                    e.stopPropagation();
                    const raw = header.querySelector('#aiDebugRaw');
                    raw.style.display = raw.style.display === 'none' ? 'block' : 'none';
                    e.target.style.color = raw.style.display === 'block' ? '#fff' : '#aaa';
                };

                grid.appendChild(header);

                if (Array.isArray(stations) && stations.length > 0) {
                    stations.forEach(item => {
                        // Ensure item is an object and has name
                        const newItem = typeof item === 'string' ? { name: item, lat: null, lng: null } : item;
                        grid.appendChild(createStationItem(newItem));
                    });
                } else {
                    const noRes = document.createElement('div');
                    noRes.style.gridColumn = "1 / -1";
                    noRes.style.textAlign = "center";
                    noRes.style.color = "#64748b";
                    noRes.innerText = "ç„¡æœ‰æ•ˆçµæœï¼Œè«‹æŸ¥çœ‹ Info";
                    grid.appendChild(noRes);
                }

            } catch (e) {
                alert("AI æœå°‹å¤±æ•—: " + e.message);
                filterStations(query);
            } finally {
                loading.style.display = 'none';
                grid.style.display = 'grid';
            }
        }

        // --- API & GPS Logic ---
        function checkKeyStatus() {
            const key = localStorage.getItem('user_gemini_key');
            const sendBtn = document.getElementById('sendBtn');
            const keyInput = document.getElementById('apiKeyInput');

            if (key) {
                sendBtn.disabled = false;
                if (keyInput.value === "") keyInput.placeholder = "é‡‘é‘°å·²å„²å­˜ (éš±è—)";
            } else {
                sendBtn.disabled = true;
            }
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('user_gemini_key', key);
                checkKeyStatus();
                document.getElementById('apiKeyInput').value = "";
                alert("é‡‘é‘°å·²å„²å­˜ï¼");
            }
        }

        function clearKey() {
            localStorage.removeItem('user_gemini_key');
            checkKeyStatus();
            location.reload();
        }

        function toggleDebug() {
            const debugArea = document.getElementById('debugArea');
            debugArea.style.display = debugArea.style.display === 'none' ? 'block' : 'none';
        }

        async function getGPS() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    resolve("ç„¡æ³•å–å¾— GPS (ç€è¦½å™¨ä¸æ”¯æ´)");
                } else {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve(`${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
                        },
                        (error) => {
                            console.warn("GPS Error:", error);
                            resolve("ç„¡æ³•å–å¾— GPS (æ¬Šé™è¢«æ‹’æˆ–éŒ¯èª¤)");
                        }
                    );
                }
            });
        }

        async function askGemini() {
            const key = localStorage.getItem('user_gemini_key');
            if (!key) return alert("è«‹å…ˆè¨­å®š API Key");

            const sendBtn = document.getElementById('sendBtn');
            const responseArea = document.getElementById('responseArea');
            const statusText = document.getElementById('statusText');

            // Clear previous results
            document.getElementById('train-result').innerHTML = '';
            document.getElementById('bus-result').innerHTML = '';
            document.getElementById('bike-result').innerHTML = '';

            sendBtn.disabled = true;
            sendBtn.innerText = "ğŸ“ å–å¾—å®šä½ä¸­...";
            statusText.innerText = "æ­£åœ¨è®€å– GPS ä½ç½®...";

            try {
                const gpsLocation = await getGPS();
                const now = new Date().toLocaleString('zh-TW', { hour12: false });

                // Extract names for prompt
                const trainList = state.train.map(getStationName).join('ã€') || "ç„¡";
                const busList = state.bus.map(getStationName).join('ã€') || "ç„¡";
                const bikeList = state.bike.map(getStationName).join('ã€') || "ç„¡";

                let finalPrompt = state.prompt
                    .replace('{TIME}', now)
                    .replace('{GPS}', gpsLocation)
                    .replace('{TRAIN_LIST}', trainList)
                    .replace('{BUS_LIST}', busList)
                    .replace('{BIKE_LIST}', bikeList);

                console.log("Sending Prompt:", finalPrompt);

                sendBtn.innerText = "ğŸ¤– æ€è€ƒä¸­...";
                statusText.innerText = "AI æ­£åœ¨åˆ†æäº¤é€šç‹€æ³...";
                responseArea.innerText = `[é€å‡ºæŸ¥è©¢]\n${finalPrompt}\n\n[ç­‰å¾…å›æ‡‰]...`;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: finalPrompt }] }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const resultText = data.candidates[0].content.parts[0].text;
                responseArea.innerText = resultText;

                // Try Parsing JSON
                try {
                    const cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const resultObj = JSON.parse(cleanJson);

                    renderResultList('train', resultObj.train);
                    renderResultList('bus', resultObj.bus);
                    renderResultList('bike', resultObj.bike);

                    statusText.innerText = `âœ… æ›´æ–°å®Œæˆ (${now})`;
                    if (resultObj.misc) {
                        statusText.innerText += ` | ${resultObj.misc}`;
                    }

                } catch (e) {
                    console.error("JSON Parse Error", e);
                    statusText.innerText = "âš ï¸ è§£æå¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°è³‡è¨Š";
                    document.getElementById('debugArea').style.display = 'block';
                }

            } catch (error) {
                console.error(error);
                statusText.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
                responseArea.innerText = "éŒ¯èª¤: " + error.message;
                document.getElementById('debugArea').style.display = 'block';
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = "å–å¾— GPS ä¸¦ç™¼é€æŸ¥è©¢";
            }
        }

        function renderResultList(type, items) {
            const container = document.getElementById(`${type}-result`);
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="padding:10px; color:#64748b; font-size:0.9em;">ç„¡è³‡æ–™</div>';
                return;
            }

            items.forEach(text => {
                const div = document.createElement('div');
                div.style.padding = "8px 0";
                div.style.borderBottom = "1px solid rgba(255, 255, 255, 0.05)";
                div.style.fontSize = "0.95em";
                div.innerText = text;
                container.appendChild(div);
            });
        }
    </script>
</body>

</html>